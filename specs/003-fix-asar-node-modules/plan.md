# Implementation Plan: Fix Missing Asset Node Modules in Packaged Application

**Branch**: `003-fix-asar-node-modules` | **Date**: 2025-10-28 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/003-fix-asar-node-modules/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

**Primary Requirement**: Ensure that webpack-copied asset dependencies (@anikitenko/fdo-sdk types, @babel/standalone, goober) are included in the packaged ASAR archive at `renderer/assets/node_modules` so that plugins can access SDK types, dynamic transpilation, and styling libraries at runtime.

**Technical Approach**: 
1. Identify and fix electron-builder configuration preventing assets directory inclusion in ASAR
2. Implement post-packaging validation that compares webpack CopyWebpackPlugin patterns against actual ASAR contents
3. Fail build immediately if validation detects missing assets
4. Ensure cross-platform compatibility (macOS, Windows, Linux)

## Technical Context

**Language/Version**: JavaScript (Node.js 20+), TypeScript 5.x (for build tooling)  
**Primary Dependencies**: 
- electron-builder 25.x (packaging)
- webpack 5.x (bundling)
- CopyWebpackPlugin 12.x (asset copying)
- asar (ASAR archive manipulation for validation)
- Node.js built-in: fs, path

**Storage**: File system (packaged ASAR archive, webpack build output)  
**Testing**: Manual verification via ASAR extraction, automated validation script  
**Target Platform**: Electron desktop app (macOS x64/arm64, Windows x64, Linux x64)  
**Project Type**: Electron desktop application (main + renderer processes)  
**Performance Goals**: 
- Validation adds <5 seconds to build time
- No impact on runtime performance
- Assets accessible through ASAR protocol with <10ms overhead

**Constraints**: 
- Assets must be in ASAR archive (not unpacked) for ASAR protocol access
- Validation must parse webpack.renderer.config.js programmatically
- Build must fail immediately on validation failure
- No breaking changes to existing packaging workflow

**Scale/Scope**: 
- 3 asset packages (~5-15MB total)
- Validation runs on each platform build independently
- Affects all platform-specific builds (4 architectures)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Plugin-First Architecture ✅ PASS

**Evaluation**: This fix ensures plugin runtime dependencies (SDK types, Babel, goober) are available in packaged applications. It directly supports the plugin ecosystem without modifying core plugin architecture.

**Compliance**: Fixing asset packaging enables plugins to function correctly in production, aligning with Constitution Principle I (Plugin-First Architecture).

### Desktop-Native Platform ✅ PASS

**Evaluation**: This fix addresses Electron packaging (electron-builder, ASAR archives) which is core to the desktop-native platform architecture.

**Compliance**: Ensures desktop packaging integrity, aligning with Constitution Principle V (Desktop-Native Platform).

### Developer Experience First ✅ PASS

**Evaluation**: Automated validation that fails fast with clear error messages prevents developers from shipping broken packages. Automatic synchronization with webpack configuration eliminates manual maintenance.

**Compliance**: Aligns with Constitution Principle III (Developer Experience First) - reducing friction and preventing errors.

### Observability & Transparency ✅ PASS

**Evaluation**: Validation provides clear error messages showing expected vs. actual asset paths, troubleshooting steps, and fails loudly rather than silently.

**Compliance**: Aligns with Constitution Principle VII (Observability & Transparency) - every significant action is observable.

### Test-First Development ⚠️ ADVISORY

**Evaluation**: This is a bug fix for packaging infrastructure. Testing will be manual (extract ASAR, verify contents) plus automated validation script.

**Compliance**: While automated validation provides verification, this doesn't add traditional unit/integration tests. The validation script itself serves as a test of packaging correctness.

**Justification**: Infrastructure/build tooling validation is appropriate for this type of fix. The validation script acts as an automated test that runs on every build.

### Summary

**Gate Status**: ✅ PASSED  
**Violations**: None  
**Advisories**: Test-First Development addressed through validation script  
**Proceed to Phase 0**: YES

## Project Structure

### Documentation (this feature)

```text
specs/003-fix-asar-node-modules/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
│   └── validation-api.md  # Validation script interface contract
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
# Electron application structure
/Users/onikiten/dev/fdo/
├── webpack.renderer.config.js    # MODIFY: Already copies assets, reference for validation
├── package.json                  # MODIFY: Add validation script, update build process
├── scripts/                      # NEW DIRECTORY
│   └── validate-asar-assets.js   # NEW: Post-packaging validation script
├── dist/
│   └── renderer/
│       └── assets/
│           └── node_modules/     # Exists after webpack build
│               ├── @anikitenko/fdo-sdk/
│               ├── @babel/standalone/
│               └── goober/
└── release/
    └── mac-arm64/
        └── FDO (FlexDevOPs).app/
            └── Contents/
                └── Resources/
                    └── app.asar  # MUST contain renderer/assets/node_modules

# No backend/frontend split - single Electron app
# No mobile components - desktop only
```

**Structure Decision**: Electron desktop application with main and renderer processes. All build tooling and validation scripts live in repository root `scripts/` directory. Webpack configuration already exists and copies assets correctly; electron-builder configuration needs adjustment to preserve assets in ASAR archive.

## Complexity Tracking

> **No constitution violations requiring justification**

The feature aligns with all constitutional principles without requiring exceptions.

## Phase 0: Research & Decisions

See [research.md](./research.md) for detailed findings.

### Research Tasks

1. **Electron-builder ASAR configuration**: How to ensure specific directories are included in ASAR archive
2. **Webpack CopyWebpackPlugin parsing**: Programmatic approach to extract copy patterns from webpack.renderer.config.js
3. **ASAR extraction and validation**: Node.js libraries and approaches for reading ASAR contents
4. **Cross-platform build integration**: Where to inject validation in npm scripts for all platforms
5. **Error handling and reporting**: Best practices for failing builds with actionable error messages

### Key Decisions (from research)

All decisions documented in research.md with rationale and alternatives.

## Phase 1: Design & Contracts

See:
- [data-model.md](./data-model.md) - Data structures and configuration
- [contracts/validation-api.md](./contracts/validation-api.md) - Validation script interface
- [quickstart.md](./quickstart.md) - Setup and usage guide

### Implementation Components

1. **Electron-builder configuration fix**: Ensure `asarUnpack` patterns don't exclude assets
2. **Validation script** (`scripts/validate-asar-assets.js`): 
   - Parse webpack.renderer.config.js to extract CopyWebpackPlugin patterns
   - Extract and inspect ASAR archive
   - Compare expected assets to actual ASAR contents
   - Exit with error code 1 if validation fails
3. **Build integration**: Update package.json scripts to run validation after electron-builder
4. **Error messaging**: Clear, actionable error output following FR-008 requirements

### Testing Strategy

1. **Manual verification**: Extract ASAR and verify directory structure
2. **Validation script testing**: Intentionally remove asset, verify build fails
3. **Cross-platform verification**: Run builds on macOS, Windows, Linux (or CI)
4. **Plugin functionality test**: Create test plugin using SDK types, Babel, goober

## Phase 2: Task Breakdown

**NOTE**: Phase 2 task breakdown is generated by `/speckit.tasks` command, not `/speckit.plan`.

This plan concludes with Phase 1 design artifacts. Execute `/speckit.tasks` to generate implementation tasks.
